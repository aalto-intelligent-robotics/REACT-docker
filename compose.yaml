services:
  base:
    container_name: react_trt
    image: react:trt
    user: ros
    build:
      target: trt
      context: .
      dockerfile: ./dockerfiles/trt.Dockerfile
    # Interactive shell
    stdin_open: true
    tty: true
    # Networking and IPC for ROS
    network_mode: host
    ipc: host
    runtime: nvidia
    environment:
      # Allows graphical programs in the container.
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
      - USER=${DOCKER_USER}
      - HOME=${DOCKER_HOME}
    volumes:
      - ./bashrc.d:${DOCKER_HOME}/.bashrc.d
      # Allows graphical programs in the container.
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev/dri:/dev/dri
      # Mount ROS workspace and bags
      - ./hydra_ws:${DOCKER_HOME}/hydra_ws
      - ./bags/:${DOCKER_HOME}/bags
      - ./dsg_output:${DOCKER_HOME}/dsg_output
      - ./logs:${DOCKER_HOME}/logs
      - ./models/:${DOCKER_HOME}/models
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

    privileged: true # GUI related
  devel:
    extends: base
    image: react:trt_devel
    container_name: react_trt_devel
    build:
      target: trt_devel
      dockerfile: ./dockerfiles/trt_devel.Dockerfile
    volumes:
      - ./tmux.conf:${DOCKER_HOME}/.tmux.conf
      - ./config/aliasrc:${DOCKER_HOME}/.config/aliasrc
      - ./config/tmux:${DOCKER_HOME}/.config/tmux
      - ./config/starship.toml:${DOCKER_HOME}/.config/starship.toml
      - ./config/zellij:${DOCKER_HOME}/.config/zellij
      - ./config/yazi:${DOCKER_HOME}/.config/yazi
      - ./config/nvim:${DOCKER_HOME}/.config/nvim
      - ./misc/nnn_ubt2004:${DOCKER_HOME}/.local/bin/nnn
      - ./zshrc:${DOCKER_HOME}/.zshrc
      - ./zshrc.d:${DOCKER_HOME}/.zshrc.d
      - ./debug:${DOCKER_HOME}/debug
